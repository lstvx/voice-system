<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avenir Lointain</title>
<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #07050f;
    --surface:   rgba(18, 12, 40, 0.50);
    --surface2:  rgba(255,255,255,0.07);
    --border:    rgba(168, 85, 247, 0.28);
    --border2:   rgba(255,255,255,0.10);
    --accent:    #7c3aed;
    --accent2:   #a855f7;
    --red:       #ef4444;
    --green:     #22c55e;
    --amber:     #f59e0b;
    --text:      #e2e8f0;
    --muted:     #6b7280;
    --subtle:    #374151;
    --radius:    16px;
    --transition: 220ms cubic-bezier(.4,0,.2,1);
    --footer-h:  3rem;
  }

  html { scroll-behavior: smooth; }

  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: var(--bg);
    background-image:
      linear-gradient(rgba(168,85,247,.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(168,85,247,.05) 1px, transparent 1px);
    background-size: 44px 44px;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    color: var(--text);
    overflow-x: hidden;
  }

  /* â”€â”€ Decorative blur blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .blob {
    position: fixed;
    border-radius: 50%;
    filter: blur(110px);
    pointer-events: none;
    z-index: 0;
    will-change: transform;
  }
  .blob-1 {
    width: 520px; height: 520px;
    background: rgba(124,58,237,.18);
    top: -160px; left: -180px;
  }
  .blob-2 {
    width: 380px; height: 380px;
    background: rgba(168,85,247,.13);
    bottom: -100px; right: -120px;
  }
  .blob-3 {
    width: 260px; height: 260px;
    background: rgba(239,68,68,.06);
    top: 40%; left: 60%;
  }

  /* â”€â”€ Sticky header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .85rem 1.5rem;
    background: rgba(10,7,20,.6);
    backdrop-filter: blur(28px) saturate(1.8);
    -webkit-backdrop-filter: blur(28px) saturate(1.8);
    border-bottom: 1px solid rgba(255,255,255,.08);
    gap: 1rem;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: .75rem;
    text-decoration: none;
    color: inherit;
  }

  .brand-logo {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
    box-shadow: 0 0 18px rgba(168,85,247,.5);
  }

  .brand-info h1 {
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: -.2px;
    line-height: 1.2;
  }

  .brand-info p {
    font-size: .72rem;
    color: var(--muted);
    margin-top: 1px;
  }

  .header-settings-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    width: 38px; height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--muted);
    flex-shrink: 0;
    transition: color var(--transition), border-color var(--transition), background var(--transition), box-shadow var(--transition);
    margin-left: auto;
  }

  .header-settings-btn:hover {
    color: var(--text);
    border-color: var(--accent);
    background: rgba(168,85,247,.15);
    box-shadow: 0 0 14px rgba(168,85,247,.3);
  }

  /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2.5rem 1rem;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ Glass card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--surface);
    backdrop-filter: blur(40px) saturate(1.8);
    -webkit-backdrop-filter: blur(40px) saturate(1.8);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 24px;
    padding: 2rem 1.75rem 1.75rem;
    width: 100%;
    max-width: 460px;
    box-shadow:
      0 0 0 1px rgba(255,255,255,.06) inset,
      0 8px 32px rgba(168,85,247,.12) inset,
      0 28px 80px rgba(0,0,0,.6),
      0 0 60px rgba(124,58,237,.1);
    position: relative;
    overflow: hidden;
  }

  /* top shimmer line */
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(168,85,247,.6), rgba(124,58,237,.5), transparent);
    border-radius: 24px 24px 0 0;
  }

  /* subtle inner glass reflection */
  .card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,.04) 0%, transparent 100%);
    border-radius: 24px 24px 0 0;
    pointer-events: none;
  }

  /* â”€â”€ Status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .status-row {
    display: flex;
    align-items: center;
    gap: .5rem;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: .6rem 1rem;
    margin-bottom: 1.5rem;
    font-size: .85rem;
  }

  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--subtle);
    flex-shrink: 0;
    transition: background var(--transition), box-shadow var(--transition);
  }

  .dot.connected   { background: var(--green); box-shadow: 0 0 8px rgba(34,197,94,.7); }
  .dot.connecting  { background: var(--amber); animation: blink 1s infinite; }
  .dot.error       { background: var(--red); }

  @keyframes blink { 0%,100% { opacity:1 } 50% { opacity:.25 } }

  #statusText { flex: 1; color: var(--muted); transition: color var(--transition); }
  #statusText.connected  { color: var(--green); }
  #statusText.connecting { color: var(--amber); }
  #statusText.error      { color: var(--red); }

  /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  label {
    display: block;
    font-size: .75rem;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .06em;
    margin-bottom: .45rem;
  }

  input[type="text"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: .75rem 1rem;
    font-size: .95rem;
    color: var(--text);
    outline: none;
    transition: border-color var(--transition), box-shadow var(--transition);
    margin-bottom: 1.25rem;
  }

  input[type="text"]:focus {
    border-color: var(--accent2);
    box-shadow: 0 0 0 3px rgba(168,85,247,.2);
  }

  input[type="text"]:disabled { opacity: .45; cursor: not-allowed; }

  /* â”€â”€ Join / Leave button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  button#joinBtn {
    width: 100%;
    padding: .85rem;
    border: none;
    border-radius: 12px;
    font-size: .97rem;
    font-weight: 700;
    cursor: pointer;
    transition: opacity var(--transition), transform var(--transition), box-shadow var(--transition);
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    letter-spacing: .02em;
    box-shadow: 0 4px 20px rgba(168,85,247,.45);
  }

  button#joinBtn.leave {
    background: linear-gradient(135deg, var(--red), #f97316);
    box-shadow: 0 4px 18px rgba(239,68,68,.35);
  }

  button#joinBtn:hover:not(:disabled) {
    opacity: .88;
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(168,85,247,.55);
  }

  button#joinBtn.leave:hover:not(:disabled) {
    box-shadow: 0 8px 26px rgba(239,68,68,.4);
  }

  button#joinBtn:disabled { opacity: .38; cursor: not-allowed; transform: none; }

  /* â”€â”€ Mic section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mic-section {
    display: none;
    margin-top: 1.5rem;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    gap: .8rem;
    flex-direction: column;
  }

  .mic-section.visible { display: flex; }

  .mic-label {
    font-size: .72rem;
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .06em;
  }

  .mic-row {
    display: flex;
    align-items: center;
    gap: .75rem;
  }

  .mic-icon {
    font-size: 1.25rem;
    transition: filter var(--transition);
  }

  .mic-icon.speaking { filter: drop-shadow(0 0 7px var(--green)); }

  .volume-bar-bg {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,.08);
    border-radius: 99px;
    overflow: hidden;
  }

  .volume-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--green), #86efac);
    border-radius: 99px;
    transition: width .07s linear;
  }

  .speaking-badge {
    font-size: .73rem;
    font-weight: 700;
    padding: .2rem .65rem;
    border-radius: 99px;
    background: rgba(255,255,255,.06);
    color: var(--muted);
    transition: background var(--transition), color var(--transition);
    white-space: nowrap;
    border: 1px solid var(--border2);
  }

  .speaking-badge.active {
    background: rgba(34,197,94,.15);
    color: var(--green);
    border-color: rgba(34,197,94,.3);
  }

  /* â”€â”€ Control buttons (mute/deafen) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .controls-row { display: flex; gap: .55rem; }

  .ctrl-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .4rem;
    padding: .55rem .75rem;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    color: var(--muted);
    font-size: .8rem;
    font-weight: 600;
    cursor: pointer;
    transition: background var(--transition), border-color var(--transition), color var(--transition), box-shadow var(--transition);
  }

  .ctrl-btn:hover {
    background: rgba(255,255,255,.07);
    border-color: rgba(255,255,255,.15);
    color: var(--text);
  }

  .ctrl-btn.active {
    background: rgba(239,68,68,.12);
    border-color: rgba(239,68,68,.4);
    color: var(--red);
  }

  /* â”€â”€ Volume slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .vol-row {
    display: flex;
    align-items: center;
    gap: .65rem;
  }

  .vol-label {
    font-size: .78rem;
    color: var(--muted);
    white-space: nowrap;
  }

  input[type="range"] {
    flex: 1;
    appearance: none;
    height: 5px;
    border-radius: 99px;
    background: rgba(255,255,255,.08);
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 15px; height: 15px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    cursor: pointer;
    transition: transform var(--transition), box-shadow var(--transition);
    box-shadow: 0 0 8px rgba(168,85,247,.6);
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.25);
    box-shadow: 0 0 14px rgba(168,85,247,.8);
  }

  .vol-value {
    font-size: .78rem;
    font-weight: 600;
    color: var(--muted);
    min-width: 2.8rem;
    text-align: right;
  }

  /* â”€â”€ Error message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #errorMsg {
    display: none;
    margin-top: 1rem;
    font-size: .8rem;
    color: var(--red);
    background: rgba(239,68,68,.08);
    border: 1px solid rgba(239,68,68,.2);
    border-radius: 8px;
    padding: .55rem .9rem;
  }

  /* â”€â”€ Speaking popup (floating) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .speaking-popup {
    position: fixed;
    bottom: calc(var(--footer-h) + 1rem);
    left: 50%;
    transform: translateX(-50%) translateY(14px);
    background: linear-gradient(135deg, var(--green), #16a34a);
    color: #fff;
    font-size: .92rem;
    font-weight: 700;
    padding: .55rem 1.4rem;
    border-radius: 99px;
    box-shadow: 0 8px 28px rgba(34,197,94,.45);
    opacity: 0;
    pointer-events: none;
    transition: opacity 220ms ease, transform 220ms ease;
    z-index: 200;
    white-space: nowrap;
  }

  .speaking-popup.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* â”€â”€ Settings overlay / modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition);
  }

  .settings-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .settings-modal {
    background: rgba(14, 8, 30, 0.75);
    backdrop-filter: blur(40px) saturate(1.8);
    -webkit-backdrop-filter: blur(40px) saturate(1.8);
    border: 1px solid rgba(255,255,255,.13);
    border-radius: 20px;
    width: 100%;
    max-width: 360px;
    margin: 1rem;
    box-shadow: 0 24px 70px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,.05) inset;
    overflow: hidden;
    transform: translateY(10px) scale(.97);
    transition: transform var(--transition);
  }

  .settings-overlay.open .settings-modal {
    transform: translateY(0) scale(1);
  }

  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.4rem;
    border-bottom: 1px solid var(--border2);
    font-weight: 700;
    font-size: .92rem;
  }

  .settings-close {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1.05rem;
    cursor: pointer;
    padding: .2rem .4rem;
    border-radius: 6px;
    transition: color var(--transition), background var(--transition);
  }

  .settings-close:hover { color: var(--text); background: var(--surface2); }

  .settings-body {
    padding: 1.2rem 1.4rem;
    display: flex;
    flex-direction: column;
    gap: .8rem;
  }

  .settings-body label { margin-bottom: 0; }

  .settings-body select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: .65rem .9rem;
    font-size: .88rem;
    color: var(--text);
    outline: none;
    cursor: pointer;
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .settings-body select:focus {
    border-color: var(--accent2);
    box-shadow: 0 0 0 3px rgba(168,85,247,.2);
  }

  .settings-hint {
    font-size: .76rem;
    color: #4b5563;
  }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .site-footer {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.25rem;
    height: var(--footer-h);
    padding: 0 1.5rem;
    border-top: 1px solid var(--border2);
    background: rgba(7,10,15,.6);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    font-size: .75rem;
    color: var(--muted);
  }

  .site-footer a {
    color: var(--muted);
    text-decoration: none;
    transition: color var(--transition);
  }

  .site-footer a:hover { color: var(--accent2); }

  .footer-dot { opacity: .3; }

  /* â”€â”€ Connected users counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .connected-counter {
    display: flex;
    align-items: center;
    gap: .5rem;
    font-size: .82rem;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 99px;
    padding: .3rem .85rem;
    white-space: nowrap;
    transition: color var(--transition);
  }

  .connected-counter .pulse {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 7px rgba(34,197,94,.7);
    flex-shrink: 0;
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 7px rgba(34,197,94,.7); }
    50%       { box-shadow: 0 0 14px rgba(34,197,94,1); }
  }

  .connected-counter strong {
    color: var(--text);
    font-weight: 700;
  }
</style>
</head>
<body>

<!-- Decorative blobs -->
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>

<!-- "Je parle" floating popup -->
<div class="speaking-popup" id="speakingPopup">ğŸ™ï¸ Je parle</div>

<!-- â”€â”€ Sticky header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="site-header">
  <div class="brand">
    <div class="brand-logo">ğŸ™ï¸</div>
    <div class="brand-info">
      <h1>Avenir Lointain</h1>
      <p>Chat vocal de proximitÃ©</p>
    </div>
  </div>
  <div class="connected-counter" id="connectedCounter" title="Utilisateurs connectÃ©s en vocal">
    <span class="pulse"></span>
    <span><strong id="connectedCount">0</strong> en vocal</span>
  </div>
  <button class="header-settings-btn" onclick="openSettings()" title="ParamÃ¨tres audio" id="settingsBtn" aria-label="Ouvrir les paramÃ¨tres audio">
    <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </button>
</header>

<!-- â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="main-content">
  <div class="card">
    <div class="status-row">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Non connectÃ©</span>
    </div>

    <label for="userIdInput">ID Utilisateur Roblox</label>
    <input type="text" id="userIdInput" placeholder="Entrez votre ID Utilisateur Roblox">
    <p id="robloxUsername" style="display:none; font-size:.82rem; color:var(--accent2); margin-top:-.7rem; margin-bottom:1.1rem; padding-left:.25rem;"></p>

    <button id="joinBtn" onclick="toggleVoice()">Rejoindre la voix</button>

    <div class="mic-section" id="micSection">
      <span class="mic-label">Microphone</span>
      <div class="mic-row">
        <span class="mic-icon" id="micIcon">ğŸ™ï¸</span>
        <div class="volume-bar-bg">
          <div class="volume-bar" id="volumeBar"></div>
        </div>
        <span class="speaking-badge" id="speakingBadge">Muet</span>
      </div>

      <div class="controls-row">
        <button class="ctrl-btn" id="muteBtn" onclick="toggleMute()">
          <span id="muteIcon">ğŸ™ï¸</span><span id="muteLbl">Couper le micro</span>
        </button>
        <button class="ctrl-btn" id="deafenBtn" onclick="toggleDeafen()">
          <span id="deafenIcon">ğŸ”Š</span><span id="deafenLbl">Sourdine</span>
        </button>
      </div>

      <div class="vol-row">
        <span class="vol-label">ğŸšï¸ Volume</span>
        <input type="range" id="volSlider" min="0" max="200" value="100" oninput="onVolSlider(this.value)">
        <span class="vol-value" id="volValue">100%</span>
      </div>
    </div>

    <div id="errorMsg"></div>
  </div>
</main>

<!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<footer class="site-footer">
  <span>Avenir Lointain</span>
  <span class="footer-dot">â€¢</span>
  <span>Chat vocal de proximitÃ©</span>
</footer>

<!-- Settings modal -->
<div class="settings-overlay" id="settingsOverlay" onclick="handleOverlayClick(event)">
  <div class="settings-modal">
    <div class="settings-header">
      <span>âš™ï¸ ParamÃ¨tres audio</span>
      <button class="settings-close" onclick="closeSettings()">âœ•</button>
    </div>
    <div class="settings-body">
      <label for="deviceSelect">PÃ©riphÃ©rique d'entrÃ©e</label>
      <select id="deviceSelect" onchange="switchDevice(this.value)">
        <option value="">Microphone par dÃ©faut</option>
      </select>
      <p class="settings-hint" id="deviceHint">Connectez-vous d'abord Ã  la voix pour activer le changement de pÃ©riphÃ©rique en direct.</p>
    </div>
  </div>
</div>

<script>
let room = null
let localTrack = null
let volumeInterval = null
let speakingFrameId = null
let connected = false
let socket = null

// Audio processing
let audioCtx = null
let gainNode = null
let analyserNode = null
let sourceNode = null
let rawMicTrack = null

// UI state
let isMuted = false
let isDeafened = false
let micGain = 1.0
let selectedDevice = null

console.log('[VoiceSystem] index.html loaded')

// Global socket for live connected count (no auth needed for count updates)
;(function initCounterSocket() {
  const countSocket = io()
  countSocket.on('connectedCount', (count) => {
    document.getElementById('connectedCount').textContent = count
  })
})()

function setStatus(state, text) {
  const dot = document.getElementById('statusDot')
  const statusText = document.getElementById('statusText')
  dot.className = 'dot ' + state
  statusText.className = state
  statusText.textContent = text
}

function showError(msg) {
  const el = document.getElementById('errorMsg')
  el.textContent = msg
  el.style.display = 'block'
}

function clearError() {
  document.getElementById('errorMsg').style.display = 'none'
}

// â”€â”€ Settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSettings() {
  loadDevices()
  document.getElementById('settingsOverlay').classList.add('open')
}

function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open')
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('settingsOverlay')) closeSettings()
}

async function loadDevices() {
  try {
    // Request permission so labels are available
    const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true })
    tempStream.getTracks().forEach(t => t.stop())

    const devices = await navigator.mediaDevices.enumerateDevices()
    const inputs = devices.filter(d => d.kind === 'audioinput')
    const sel = document.getElementById('deviceSelect')
    sel.innerHTML = '<option value="">Microphone par dÃ©faut</option>'
    inputs.forEach((d, i) => {
      const opt = document.createElement('option')
      opt.value = d.deviceId
      opt.textContent = d.label || 'Microphone ' + (i + 1)
      if (d.deviceId === selectedDevice) opt.selected = true
      sel.appendChild(opt)
    })
    console.log('[VoiceSystem] Enumerated', inputs.length, 'audio input devices')
  } catch (e) {
    console.warn('[VoiceSystem] Could not enumerate devices:', e)
  }
}

async function switchDevice(deviceId) {
  selectedDevice = deviceId || null
  const hint = document.getElementById('deviceHint')
  if (!connected || !audioCtx || !gainNode) {
    hint.textContent = 'Sera utilisÃ© lors de la prochaine connexion.'
    return
  }
  hint.textContent = 'Changement de pÃ©riphÃ©riqueâ€¦'
  try {
    const constraints = { audio: selectedDevice ? { deviceId: { exact: selectedDevice } } : true }
    const newStream = await navigator.mediaDevices.getUserMedia(constraints)
    const newRawTrack = newStream.getAudioTracks()[0]

    // Disconnect old source, stop old track
    if (sourceNode) { sourceNode.disconnect(); sourceNode = null }
    if (rawMicTrack) rawMicTrack.stop()
    rawMicTrack = newRawTrack

    // Connect new source into existing gain node
    sourceNode = audioCtx.createMediaStreamSource(newStream)
    sourceNode.connect(gainNode)

    hint.textContent = 'PÃ©riphÃ©rique changÃ© avec succÃ¨s.'
    console.log('[VoiceSystem] Device switched to:', selectedDevice || 'default')
  } catch (e) {
    console.error('[VoiceSystem] Device switch failed:', e)
    showError('Ã‰chec du changement de pÃ©riphÃ©rique : ' + (e.message || e))
    hint.textContent = 'Ã‰chec du changement de pÃ©riphÃ©rique.'
  }
}

// â”€â”€ Mute / Deafen / Volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleMute() {
  if (!connected) return
  isMuted = !isMuted
  gainNode.gain.value = isMuted ? 0 : micGain

  const btn = document.getElementById('muteBtn')
  btn.classList.toggle('active', isMuted)
  document.getElementById('muteIcon').textContent = isMuted ? 'ğŸš«' : 'ğŸ™ï¸'
  document.getElementById('muteLbl').textContent = isMuted ? 'Activer le micro' : 'Couper le micro'

  if (isMuted) {
    document.getElementById('speakingBadge').textContent = 'Muet'
    document.getElementById('speakingBadge').classList.remove('active')
    document.getElementById('micIcon').classList.remove('speaking')
    document.getElementById('volumeBar').style.width = '0%'
    document.getElementById('speakingPopup').classList.remove('visible')
  } else {
    document.getElementById('speakingBadge').textContent = 'Silencieux'
    document.getElementById('speakingBadge').classList.remove('active')
    document.getElementById('micIcon').classList.remove('speaking')
  }
  console.log('[VoiceSystem] Mute toggled:', isMuted)
}

function toggleDeafen() {
  if (!connected) return
  isDeafened = !isDeafened

  const btn = document.getElementById('deafenBtn')
  btn.classList.toggle('active', isDeafened)
  document.getElementById('deafenIcon').textContent = isDeafened ? 'ğŸ”‡' : 'ğŸ”Š'
  document.getElementById('deafenLbl').textContent = isDeafened ? 'DÃ©sactiver sourdine' : 'Sourdine'
  console.log('[VoiceSystem] Deafen toggled:', isDeafened)
}

function onVolSlider(val) {
  micGain = val / 100
  document.getElementById('volValue').textContent = val + '%'
  if (gainNode && !isMuted) gainNode.gain.value = micGain
  console.log('[VoiceSystem] Mic gain set to:', micGain)
}

// â”€â”€ Voice connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function cleanupAudio() {
  if (sourceNode) { sourceNode.disconnect(); sourceNode = null }
  if (rawMicTrack) { rawMicTrack.stop(); rawMicTrack = null }
  if (audioCtx) { audioCtx.close(); audioCtx = null }
  gainNode = null; analyserNode = null
}

async function toggleVoice() {
  if (connected) {
    await leave()
  } else {
    await join()
  }
}

async function join() {
  clearError()
  const userId = document.getElementById('userIdInput').value.trim()
  if (!userId) {
    showError('Veuillez entrer votre ID Utilisateur Roblox.')
    return
  }
  console.log('[VoiceSystem] join() called | userId:', userId)

  const btn = document.getElementById('joinBtn')
  btn.disabled = true
  document.getElementById('userIdInput').disabled = true
  setStatus('connecting', 'Authentificationâ€¦')

  let data
  try {
    console.log('[VoiceSystem] Sending auth request...')
    const res = await fetch('/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    })
    data = await res.json()
    if (!res.ok) {
      console.warn('[VoiceSystem] Auth failed | status:', res.status, '| error:', data.error)
      showError(data.error || 'Authentification Ã©chouÃ©e.')
      setStatus('error', 'Authentification Ã©chouÃ©e')
      btn.disabled = false
      document.getElementById('userIdInput').disabled = false
      return
    }
    console.log('[VoiceSystem] Auth OK | LiveKit URL:', data.url)
    if (data.username) {
      const usernameEl = document.getElementById('robloxUsername')
      usernameEl.textContent = 'ğŸ‘¤ ' + data.username
      usernameEl.style.display = 'block'
    }
  } catch (e) {
    console.error('[VoiceSystem] Auth request threw:', e)
    showError('Impossible de joindre le serveur. VÃ©rifiez votre connexion.')
    setStatus('error', 'Serveur inaccessible')
    btn.disabled = false
    document.getElementById('userIdInput').disabled = false
    return
  }

  setStatus('connecting', 'Connexion Ã  la salle vocaleâ€¦')

  try {
    const constraints = { audio: selectedDevice ? { deviceId: { exact: selectedDevice } } : true }
    console.log('[VoiceSystem] Requesting microphone access...')
    const stream = await navigator.mediaDevices.getUserMedia(constraints)
    rawMicTrack = stream.getAudioTracks()[0]

    audioCtx = new AudioContext()
    sourceNode = audioCtx.createMediaStreamSource(stream)
    gainNode = audioCtx.createGain()
    gainNode.gain.value = micGain
    analyserNode = audioCtx.createAnalyser()
    analyserNode.fftSize = 256
    const dest = audioCtx.createMediaStreamDestination()

    sourceNode.connect(gainNode)
    gainNode.connect(analyserNode)
    gainNode.connect(dest)
    console.log('[VoiceSystem] Audio processing chain created')

    room = new LivekitClient.Room()
    console.log('[VoiceSystem] LiveKit Room created')

    room.on(LivekitClient.RoomEvent.Disconnected, () => {
      console.log('[VoiceSystem] Room disconnected event fired')
      if (connected) leave()
    })

    console.log('[VoiceSystem] Connecting to LiveKit room...')
    await room.connect(data.url, data.token)
    console.log('[VoiceSystem] Connected to LiveKit room')

    localTrack = new LivekitClient.LocalAudioTrack(dest.stream.getAudioTracks()[0])
    await room.localParticipant.publishTrack(localTrack)
    console.log('[VoiceSystem] Processed microphone track published')
  } catch (e) {
    console.error('[VoiceSystem] Connection/track error:', e)
    showError('Impossible de se connecter Ã  la salle vocale : ' + (e.message || e))
    setStatus('error', 'Connexion Ã©chouÃ©e')
    btn.disabled = false
    document.getElementById('userIdInput').disabled = false
    cleanupAudio()
    room = null; localTrack = null
    return
  }

  connected = true
  isMuted = false
  isDeafened = false
  setStatus('connected', 'ConnectÃ© â€” voix active')
  btn.textContent = 'Quitter la voix'
  btn.classList.add('leave')
  btn.disabled = false
  document.getElementById('micSection').classList.add('visible')
  document.getElementById('deviceHint').textContent = 'ConnectÃ© â€” changement de pÃ©riphÃ©rique en direct disponible.'
  console.log('[VoiceSystem] Fully connected | starting speaking detection and volume sync')

  startSpeakingDetection(userId)
  startVolumeSync(userId)
}

async function leave() {
  console.log('[VoiceSystem] leave() called')
  connected = false

  if (speakingFrameId) { cancelAnimationFrame(speakingFrameId); speakingFrameId = null }
  if (volumeInterval) { clearInterval(volumeInterval); volumeInterval = null }
  if (socket) { socket.disconnect(); socket = null }
  cleanupAudio()
  if (localTrack) { localTrack.stop(); localTrack = null }
  if (room) { room.disconnect(); room = null }

  isMuted = false
  isDeafened = false

  setStatus('', 'Non connectÃ©')
  const btn = document.getElementById('joinBtn')
  btn.textContent = 'Rejoindre la voix'
  btn.classList.remove('leave')
  document.getElementById('userIdInput').disabled = false
  document.getElementById('micSection').classList.remove('visible')
  document.getElementById('volumeBar').style.width = '0%'
  document.getElementById('speakingBadge').textContent = 'Muet'
  document.getElementById('speakingBadge').classList.remove('active')
  document.getElementById('micIcon').classList.remove('speaking')
  document.getElementById('speakingPopup').classList.remove('visible')

  document.getElementById('muteBtn').classList.remove('active')
  document.getElementById('muteIcon').textContent = 'ğŸ™ï¸'
  document.getElementById('muteLbl').textContent = 'Couper le micro'
  document.getElementById('deafenBtn').classList.remove('active')
  document.getElementById('deafenIcon').textContent = 'ğŸ”Š'
  document.getElementById('deafenLbl').textContent = 'Sourdine'

  const usernameEl = document.getElementById('robloxUsername')
  usernameEl.style.display = 'none'
  usernameEl.textContent = ''
}

function startSpeakingDetection(userId) {
  console.log('[VoiceSystem] startSpeakingDetection() | userId:', userId)
  socket = io({ auth: { userId } })
  socket.on('connect_error', (e) => {
    console.warn('[VoiceSystem] socket.io connection error:', e.message)
    showError('DÃ©tection de la parole indisponible : ' + e.message)
  })
  socket.on('disconnect', (reason) => {
    console.warn('[VoiceSystem] socket.io disconnected:', reason)
  })
  console.log('[VoiceSystem] socket.io connecting...')

  const arr = new Uint8Array(analyserNode.frequencyBinCount)
  let lastSpeaking = null
  let frameCount = 0

  function loop() {
    if (!connected) {
      console.log('[VoiceSystem] Speaking detection loop stopped (disconnected)')
      return
    }
    analyserNode.getByteFrequencyData(arr)
    const volume = arr.reduce((a, b) => a + b, 0) / arr.length
    const speaking = volume > 30

    frameCount++
    if (frameCount % 300 === 0) {
      console.log('[VoiceSystem] Speaking loop alive | volume:', volume.toFixed(2), '| speaking:', speaking)
    }

    // Update mic visualizer (respect mute)
    document.getElementById('volumeBar').style.width = isMuted ? '0%' : Math.min(volume, 100) + '%'

    if (speaking !== lastSpeaking) {
      lastSpeaking = speaking
      console.log('[VoiceSystem] Speaking state changed ->', speaking, '| volume:', volume.toFixed(2))
      if (!isMuted) {
        document.getElementById('speakingBadge').textContent = speaking ? 'En train de parler' : 'Silencieux'
        document.getElementById('speakingBadge').classList.toggle('active', speaking)
        document.getElementById('micIcon').classList.toggle('speaking', speaking)
        document.getElementById('speakingPopup').classList.toggle('visible', speaking)
      }
      // HTTP POST on state change so Roblox's next poll always finds fresh data
      fetch('/speaking', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, speaking })
      }).catch(() => {})
    }

    socket.emit('speaking', { speaking })

    speakingFrameId = requestAnimationFrame(loop)
  }

  loop()
}

function startVolumeSync(userId) {
  console.log('[VoiceSystem] startVolumeSync() | userId:', userId)
  const lastVolumes = {}
  volumeInterval = setInterval(async () => {
    if (!room) return
    try {
      const res = await fetch('/volumes/' + userId)
      const volumes = await res.json()
      const keys = Object.keys(volumes)
      if (keys.length > 0 && JSON.stringify(volumes) !== JSON.stringify(lastVolumes._prev)) {
        console.log('[VoiceSystem] Volumes updated | participants:', keys.length, '| volumes:', JSON.stringify(volumes))
        lastVolumes._prev = volumes
      }
      room.remoteParticipants.forEach(p => {
        const rawVol = volumes[p.identity] || 0
        const vol = isDeafened ? 0 : rawVol
        p.audioTrackPublications.forEach(pub => {
          if (pub.audioTrack) {
            if (lastVolumes[p.identity] !== vol) {
              console.log('[VoiceSystem] Volume changed for', p.identity, '->', vol)
              lastVolumes[p.identity] = vol
            }
            pub.audioTrack.setVolume(vol)
          }
        })
      })
    } catch (e) {
      console.warn('[VoiceSystem] /volumes fetch failed:', e)
    }
  }, 200)
}
</script>

</body>
</html>
